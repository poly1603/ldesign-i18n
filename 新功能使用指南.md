# @ldesign/i18n 新功能使用指南

本指南介绍 v3.0 优化后新增的开发工具和功能。

## 🔍 翻译键验证器

### 基本使用

```typescript
import { globalKeyValidator, validateTranslationKey } from '@ldesign/i18n'

// 方法1: 使用全局验证器
globalKeyValidator.setAvailableKeys(['app.title', 'app.description', 'user.name'])

const result = globalKeyValidator.validateKey('app.titel') // 拼写错误
console.log(result)
// {
//   isValid: false,
//   suggestions: ['app.title'],
//   didYouMean: 'app.title',
//   score: 0.9
// }

// 方法2: 快速验证
const quickResult = validateTranslationKey('user.name', ['user.name', 'user.email'])
// { isValid: true, suggestions: [], score: 1 }
```

### 批量验证

```typescript
const keys = ['app.title', 'app.desciption', 'user.nmae'] // 有拼写错误

const results = globalKeyValidator.validateKeys(keys)
const invalidKeys = globalKeyValidator.getInvalidKeys(keys)

console.log('无效的键:', invalidKeys)
// ['app.desciption', 'user.nmae']

const stats = globalKeyValidator.getValidationStats(keys)
console.log('验证统计:', stats)
// { total: 3, valid: 1, invalid: 2, validRate: 0.33 }
```

### 在翻译前自动验证

```typescript
const i18n = new OptimizedI18n({ /* ... */ })

// 设置验证器
globalKeyValidator.setAvailableKeys(
  i18n.getMessages('zh-CN') ? Object.keys(flattenObject(i18n.getMessages('zh-CN'))) : []
)

// 翻译前验证
function safeTranslate(key: string) {
  const validation = globalKeyValidator.validateKey(key)

  if (!validation.isValid && validation.didYouMean) {
    console.warn(`键 "${key}" 不存在,你是否想要 "${validation.didYouMean}"?`)
  }

  return i18n.t(key)
}
```

## 📊 性能分析器

### 基本性能分析

```typescript
import { globalProfiler } from '@ldesign/i18n/debug'

// 开始分析
globalProfiler.startProfiling()

// 执行翻译操作
i18n.t('app.title')
i18n.t('user.profile.name', { name: 'John' })
i18n.plural('item', 5)

// 停止并获取报告
const report = globalProfiler.stopProfiling()

console.log('总操作数:', report.totalOperations)
console.log('平均耗时:', report.averageDuration.toFixed(2), 'ms')
console.log('缓存命中率:', (report.cacheHitRate! * 100).toFixed(1), '%')
console.log('优化建议:', report.recommendations)
```

### 高级性能分析

```typescript
// 手动标记操作
const operationId = globalProfiler.markStart('custom-operation', 'translation', {
  component: 'UserProfile'
})

// ... 执行耗时操作 ...

globalProfiler.markEnd(operationId)

// 获取慢操作
const slowOps = globalProfiler.getSlowOperations(10) // 超过 10ms 的操作
console.log('慢操作:', slowOps)

// 导出数据
const data = globalProfiler.exportData()
console.log('性能数据:', data)
```

### 使用装饰器

```typescript
import { performanceTracker } from '@ldesign/i18n/debug'

class TranslationService {
  @performanceTracker('translation')
  translate(key: string): string {
    return i18n.t(key)
  }

  @performanceTracker('load')
  async loadLanguage(locale: string) {
    // ... 加载逻辑 ...
  }
}
```

## 🔎 翻译检查器

### 追踪翻译使用

```typescript
import { globalInspector } from '@ldesign/i18n/debug'

// 设置可用的键
globalInspector.setAvailableKeys(['app.title', 'app.description', 'user.name'])

// 开始追踪
globalInspector.startTracking()

// 翻译时自动记录
// (需要在 i18n.t() 中集成,或手动记录)
globalInspector.recordTranslation('app.title', 'zh-CN', true)
globalInspector.recordTranslation('app.missing', 'zh-CN', false)

// 生成报告
const report = globalInspector.generateReport()

console.log('总调用:', report.totalCalls)
console.log('唯一键:', report.uniqueKeys)
console.log('缺失的键:', report.missingKeys)
console.log('最常用的键:', report.mostUsed)
console.log('未使用的键:', report.unusedKeys)
console.log('覆盖率:', report.coverage.percentage.toFixed(1), '%')
```

### 导出使用报告

```typescript
// 导出为 JSON
const jsonReport = globalInspector.exportReport('json')
console.log(jsonReport)

// 导出为 CSV
const csvReport = globalInspector.exportReport('csv')
// 可以保存为文件或复制到 Excel

// 实时统计
const stats = globalInspector.getRealTimeStats()
console.log('实时统计:', stats)
// { trackedKeys: 15, totalCalls: 142, missingCount: 3, locales: 2 }
```

### 可视化调试 (浏览器)

```typescript
// 高亮显示缺失的翻译
globalInspector.highlightMissingKeys()

// 显示翻译边界
globalInspector.showTranslationBoundaries()
```

## 🎨 集成到项目

### Vue 3 项目集成

```vue
<template>
  <div>
    <h1>{{ t('app.title') }}</h1>
    <button @click="showDebugInfo">查看调试信息</button>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from '@ldesign/i18n/vue';
import { globalInspector, globalProfiler } from '@ldesign/i18n/debug';

const { t } = useI18n();

// 开发环境启用调试
if (import.meta.env.DEV) {
  globalInspector.startTracking();
  globalProfiler.startProfiling();
}

function showDebugInfo() {
  const report = globalInspector.generateReport();
  const perfReport = globalProfiler.stopProfiling();

  console.group('🐛 调试信息');
  console.log('缺失的键:', report.missingKeys);
  console.log('性能建议:', perfReport.recommendations);
  console.groupEnd();
}
</script>
```

### React 项目集成

```tsx
import { globalInspector } from '@ldesign/i18n/debug'
import { useEffect } from 'react'

function App() {
  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      globalInspector.startTracking()

      return () => {
        const report = globalInspector.generateReport()
        console.log('翻译使用报告:', report)
        globalInspector.stopTracking()
      }
    }
  }, [])

  return <div>{/* ... */}</div>
}
```

## 🔧 配置建议

### 开发环境配置

```typescript
import { createI18n, globalKeyValidator } from '@ldesign/i18n'
import { globalInspector, globalProfiler } from '@ldesign/i18n/debug'

const i18n = createI18n({
  locale: 'zh-CN',
  messages: { /* ... */ },

  // 启用详细调试
  debug: true,
  warnOnMissing: true,

  // 自定义缺失键处理
  missingKeyHandler: (key, locale, namespace, defaultValue) => {
    // 记录到检查器
    globalInspector.recordTranslation(key, locale, false)

    // 验证并提供建议
    const validation = globalKeyValidator.validateKey(key)
    if (validation.didYouMean) {
      console.warn(`键 "${key}" 不存在,你是否想要 "${validation.didYouMean}"?`)
    }

    return defaultValue || `[${key}]`
  },
})

// 启动工具
if (import.meta.env.DEV) {
  globalProfiler.startProfiling()
  globalInspector.startTracking()

  // 5分钟后生成报告
  setTimeout(() => {
    console.log('性能报告:', globalProfiler.stopProfiling())
    console.log('使用报告:', globalInspector.generateReport())
  }, 5 * 60 * 1000)
}
```

### 生产环境配置

```typescript
import { createI18n } from '@ldesign/i18n'

const i18n = createI18n({
  locale: 'zh-CN',
  messages: { /* ... */ },

  // 生产环境静默模式
  debug: false,
  warnOnMissing: false,

  // 简单的缺失键处理
  missingKeyHandler: (key, locale, namespace, defaultValue) => {
    // 可以上报到错误监控服务
    return defaultValue || key
  },
})
```

## 💡 最佳实践

### 1. 开发阶段使用验证器

在开发新功能前,先验证翻译键:

```typescript
const keysToTranslate = ['feature.title', 'feature.description']
const stats = globalKeyValidator.getValidationStats(keysToTranslate)

if (stats.invalid > 0) {
  console.warn(`发现 ${stats.invalid} 个无效的翻译键,请先添加翻译!`)
}
```

### 2. 定期生成性能报告

```typescript
// 在应用启动时
if (import.meta.env.DEV) {
  setInterval(() => {
    const report = globalProfiler.stopProfiling()
    console.log('📊 性能报告:', report.recommendations)
    globalProfiler.startProfiling() // 重新开始
  }, 10 * 60 * 1000) // 每10分钟
}
```

### 3. 发布前检查覆盖率

```typescript
const report = globalInspector.generateReport()

if (report.coverage.percentage < 80) {
  console.warn(`⚠️ 翻译覆盖率较低: ${report.coverage.percentage.toFixed(1)}%`)
  console.log('未使用的键:', report.unusedKeys.slice(0, 10))
}
```

## 🆘 常见问题

### Q: 性能分析器会影响性能吗?

A: 会有轻微影响(~1-2%),建议仅在开发环境或性能调优时启用。

### Q: 翻译检查器需要手动记录吗?

A: 目前是的。未来版本会考虑自动集成到 i18n.t() 中。

### Q: 这些工具会增加打包体积吗?

A: 不会。使用懒加载导出,仅在开发环境或主动导入时才加载。

## 📚 相关文档

- [优化完成总结](./优化完成总结_2025.md)
- [优化进度报告](./OPTIMIZATION_PROGRESS.md)
- [API 参考](./API_REFERENCE_NEW.md)

---

**最后更新**: 2025-10-25
